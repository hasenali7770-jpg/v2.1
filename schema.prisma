generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String?  @unique
  phone        String?  @unique
  name         String?
  password     String?
  role         Role     @default(USER)
  image        String?
  bio          String?
  emailVerified DateTime?
  phoneVerified DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  courses      Course[]
  enrollments  Enrollment[]
  comments     Comment[]
  likes        Like[]
  notifications Notification[]
  settings     UserSettings?
  activityLogs ActivityLog[]

  @@unique([email, phone])
}

model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  theme     String   @default("system")
  language  String   @default("ar")
  notifications Json   @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String   @db.Text
  shortDesc   String?
  price       Float
  image       String?
  videoUrl    String?
  category    String?
  level       String?
  duration    Int?
  lessons     Int?
  students    Int      @default(0)
  rating      Float    @default(0)
  published   Boolean  @default(false)
  featured    Boolean  @default(false)
  authorId    String
  content     Json?    // للمحتوى المنظم
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author      User       @relation(fields: [authorId], references: [id])
  enrollments Enrollment[]
  comments    Comment[]
  sections    CourseSection[]
  attachments CourseAttachment[]
  reviews     Review[]
}

model CourseSection {
  id        String   @id @default(cuid())
  title     String
  order     Int
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  lessons   Lesson[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  videoUrl    String?
  duration    Int?
  order       Int
  free        Boolean  @default(false)
  sectionId   String
  section     CourseSection @relation(fields: [sectionId], references: [id])
  attachments LessonAttachment[]
  completedBy Completion[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CourseAttachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String
  size      Int?
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  createdAt DateTime @default(now())
}

model LessonAttachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String
  size      Int?
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  createdAt DateTime @default(now())
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  progress  Float    @default(0)
  completed Boolean  @default(false)
  completedAt DateTime?
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User       @relation(fields: [userId], references: [id])
  course          Course     @relation(fields: [courseId], references: [id])
  completedLessons Completion[]
  payments        Payment[]

  @@unique([userId, courseId])
}

model Completion {
  id           String   @id @default(cuid())
  userId       String
  lessonId     String
  enrollmentId String
  completedAt  DateTime @default(now())

  lesson     Lesson     @relation(fields: [lessonId], references: [id])
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])

  @@unique([userId, lessonId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  userId    String
  courseId  String?
  lessonId  String?
  parentId  String?
  likes     Int      @default(0)
  status    String   @default("published") // published, pending, hidden
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id])
  course   Course?   @relation(fields: [courseId], references: [id])
  lesson   Lesson?   @relation(fields: [lessonId], references: [id])
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")
  likesRel Like[]
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  comment Comment @relation(fields: [commentId], references: [id])

  @@unique([userId, commentId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
}

model Payment {
  id         String   @id @default(cuid())
  amount     Float
  method     String   // qi_card, zain_cash, etc.
  status     String   @default("pending") // pending, completed, failed
  userId     String
  enrollmentId String?
  courseId   String
  transactionId String? @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  course    Course    @relation(fields: [courseId], references: [id])
  enrollment Enrollment? @relation(fields: [enrollmentId], references: [id])
}

model ActivationCode {
  id        String   @id @default(cuid())
  code      String   @unique
  courseId  String
  userId    String?
  used      Boolean  @default(false)
  usedAt    DateTime?
  expiresAt DateTime?
  createdBy String?
  createdAt DateTime @default(now())

  course Course  @relation(fields: [courseId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   // info, success, warning, error
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model SiteContent {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  type      String   // text, image, json
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  USER
  ADMIN
  INSTRUCTOR
  MODERATOR
}
