generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email     String?  @unique
  phone     String?  @unique
  name      String?
  avatarUrl String?  @map("avatar_url")
  bio       String?
  role      String   @default("user")
  createdAt DateTime @map("created_at") @default(now())
  updatedAt DateTime @map("updated_at") @updatedAt

  courses       Course[]
  enrollments   Enrollment[]
  comments      Comment[]
  payments      Payment[]
  notifications Notification[]

  @@map("profiles")
}

model Course {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title       String
  slug        String   @unique
  description String?  @db.Text
  price       Float
  image       String?
  category    String?
  level       String   @default("beginner")
  published   Boolean  @default(false)
  authorId    String?  @map("author_id") @db.Uuid
  createdAt   DateTime @map("created_at") @default(now())
  updatedAt   DateTime @map("updated_at") @updatedAt

  author      User       @relation(fields: [authorId], references: [id])
  sections    Section[]
  enrollments Enrollment[]
  comments    Comment[]
  payments    Payment[]

  @@map("courses")
}

model Section {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title       String
  order       Int
  courseId    String   @map("course_id") @db.Uuid
  createdAt   DateTime @map("created_at") @default(now())

  course   Course   @relation(fields: [courseId], references: [id])
  lessons  Lesson[]

  @@map("sections")
}

model Lesson {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title       String
  videoUrl    String?  @map("video_url")
  duration    Int?
  order       Int
  free        Boolean  @default(false)
  sectionId   String   @map("section_id") @db.Uuid
  createdAt   DateTime @map("created_at") @default(now())

  section      Section          @relation(fields: [sectionId], references: [id])
  completions  Completion[]
  comments     Comment[]        // هذه العلاقة مهمة جداً!

  @@map("lessons")
}

model Enrollment {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  courseId  String   @map("course_id") @db.Uuid
  progress  Float    @default(0)
  completed Boolean  @default(false)
  createdAt DateTime @map("created_at") @default(now())

  user      User       @relation(fields: [userId], references: [id])
  course    Course     @relation(fields: [courseId], references: [id])
  completions Completion[]
  payments   Payment[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model Completion {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  lessonId     String   @map("lesson_id") @db.Uuid
  enrollmentId String   @map("enrollment_id") @db.Uuid
  completedAt  DateTime @map("completed_at") @default(now())

  user       User       @relation(fields: [userId], references: [id])
  lesson     Lesson     @relation(fields: [lessonId], references: [id])
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])

  @@unique([userId, lessonId])
  @@map("completions")
}

model Comment {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  content   String   @db.Text
  userId    String   @map("user_id") @db.Uuid
  courseId  String?  @map("course_id") @db.Uuid
  lessonId  String?  @map("lesson_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  likes     Int      @default(0)
  status    String   @default("published")
  createdAt DateTime @map("created_at") @default(now())

  user    User     @relation(fields: [userId], references: [id])
  course  Course?  @relation(fields: [courseId], references: [id])
  lesson  Lesson?  @relation(fields: [lessonId], references: [id])   // هذه مرتبطة مع Lesson.comments
  parent  Comment? @relation("comment_replies", fields: [parentId], references: [id])
  replies Comment[] @relation("comment_replies")

  @@map("comments")
}

model Payment {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  amount    Float
  method    String
  status    String   @default("pending")
  userId    String   @map("user_id") @db.Uuid
  courseId  String   @map("course_id") @db.Uuid
  createdAt DateTime @map("created_at") @default(now())

  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@map("payments")
}

model Notification {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @map("created_at") @default(now())

  user User @relation(fields: [userId], references: [id])

  @@map("notifications")
}
