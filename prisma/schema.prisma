generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email         String?   @unique
  phone         String?   @unique
  name          String?
  avatarUrl     String?   @map("avatar_url")
  bio           String?
  role          String    @default("user")
  createdAt     DateTime  @map("created_at") @default(now())
  updatedAt     DateTime  @map("updated_at") @updatedAt

  // Relations
  courses       Course[]
  enrollments   Enrollment[]
  comments      Comment[]
  commentLikes  CommentLike[]
  reviews       Review[]
  notifications Notification[]
  payments      Payment[]
  activationCodes ActivationCode[]
  ownedCourses  Course[]   @relation("CourseAuthor") // courses authored by user

  @@map("profiles")
}

model Course {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title       String
  slug        String    @unique
  description String?   @db.Text
  shortDesc   String?   @map("short_desc")
  price       Float
  image       String?
  videoUrl    String?   @map("video_url")
  category    String?
  level       String    @default("beginner")
  duration    Int?
  lessons     Int       @default(0)
  students    Int       @default(0)
  rating      Float     @default(0)
  published   Boolean   @default(false)
  featured    Boolean   @default(false)
  authorId    String?   @map("author_id") @db.Uuid
  createdAt   DateTime  @map("created_at") @default(now())
  updatedAt   DateTime  @map("updated_at") @updatedAt

  // Relations
  author      User       @relation("CourseAuthor", fields: [authorId], references: [id])
  sections    Section[]
  enrollments Enrollment[]
  comments    Comment[]
  reviews     Review[]
  payments    Payment[]
  activationCodes ActivationCode[]

  @@map("courses")
}

model Section {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title       String
  description String?
  order       Int
  courseId    String    @map("course_id") @db.Uuid
  createdAt   DateTime  @map("created_at") @default(now())
  updatedAt   DateTime  @map("updated_at") @updatedAt

  // Relations
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@map("sections")
}

model Lesson {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title       String
  description String?
  videoUrl    String?   @map("video_url")
  duration    Int?
  order       Int
  free        Boolean   @default(false)
  sectionId   String    @map("section_id") @db.Uuid
  createdAt   DateTime  @map("created_at") @default(now())
  updatedAt   DateTime  @map("updated_at") @updatedAt

  // Relations
  section         Section           @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  completedLessons CompletedLesson[]
  comments        Comment[]

  @@map("lessons")
}

model Enrollment {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  courseId    String    @map("course_id") @db.Uuid
  progress    Float     @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @map("created_at") @default(now())
  updatedAt   DateTime  @map("updated_at") @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completedLessons CompletedLesson[]
  payments        Payment[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model CompletedLesson {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  lessonId     String   @map("lesson_id") @db.Uuid
  enrollmentId String   @map("enrollment_id") @db.Uuid
  completedAt  DateTime @map("completed_at") @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("completed_lessons")
}

model Comment {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  content   String   @db.Text
  userId    String   @map("user_id") @db.Uuid
  courseId  String?  @map("course_id") @db.Uuid
  lessonId  String?  @map("lesson_id") @db.Uuid
  parentId  String?  @map("parent_id") @db.Uuid
  likes     Int      @default(0)
  status    String   @default("published")
  createdAt DateTime @map("created_at") @default(now())
  updatedAt DateTime @map("updated_at") @updatedAt

  // Relations
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson   Lesson?    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  parent   Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[]  @relation("CommentReplies")
  likesRel CommentLike[]

  @@map("comments")
}

model CommentLike {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  commentId String   @map("comment_id") @db.Uuid
  createdAt DateTime @map("created_at") @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("comment_likes")
}

model Review {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  rating    Int
  comment   String?
  userId    String   @map("user_id") @db.Uuid
  courseId  String   @map("course_id") @db.Uuid
  createdAt DateTime @map("created_at") @default(now())
  updatedAt DateTime @map("updated_at") @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("reviews")
}

model Payment {
  id            String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  amount        Float
  method        String
  status        String   @default("pending")
  userId        String   @map("user_id") @db.Uuid
  courseId      String   @map("course_id") @db.Uuid
  enrollmentId  String?  @map("enrollment_id") @db.Uuid
  transactionId String?  @map("transaction_id") @unique
  createdAt     DateTime @map("created_at") @default(now())
  updatedAt     DateTime @map("updated_at") @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrollment Enrollment? @relation(fields: [enrollmentId], references: [id], onDelete: SetNull)

  @@map("payments")
}

model ActivationCode {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code      String   @unique
  courseId  String   @map("course_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  used      Boolean  @default(false)
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime? @map("expires_at")
  createdBy String?  @map("created_by") @db.Uuid
  createdAt DateTime @map("created_at") @default(now())

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activation_codes")
}

model Notification {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  title     String
  message   String
  type      String   @default("info")
  read      Boolean  @default(false)
  link      String?
  createdAt DateTime @map("created_at") @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model SiteContent {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  key       String   @unique
  value     Json
  type      String   @default("text")
  updatedBy String?  @map("updated_by") @db.Uuid
  createdAt DateTime @map("created_at") @default(now())
  updatedAt DateTime @map("updated_at") @updatedAt

  // Relations
  editor User? @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  @@map("site_content")
}
